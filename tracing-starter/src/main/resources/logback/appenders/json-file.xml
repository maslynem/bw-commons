<included>

    <springProperty name="APPENDER_FILE_ENABLE" source="logging.appender.file.enable"  defaultValue="false"/>
    <springProperty name="LOG_FILE_NAME" source="logging.file.name" defaultValue="${APP_NAME}.log"/>
    <springProperty name="LOG_FILE_PATH" source="logging.file.path" defaultValue="/var/app-logs"/>
    <springProperty name="LOG_FILE_ROLLING_PATTERN" source="logging.logback.rollingpolicy.file-name-pattern"
                    defaultValue="${LOG_FILE_PATH}/archived/app.%d{yyyy-MM-dd}.%i.log.gz"/>
    <springProperty name="LOG_FILE_ROLLING_MAX_FILE_SIZE" source="logging.logback.rollingpolicy.max-file-size"
                    defaultValue="50MB"/>
    <springProperty name="LOG_FILE_ROLLING_MAX_HISTORY" source="logging.logback.rollingpolicy.max-history" defaultValue="14"/>
    <springProperty name="LOG_FILE_ROLLING_TOTAL_SIZE_CAP" source="logging.logback.rollingpolicy.total-size-cap"
                    defaultValue="5GB"/>


    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE_PATH}/${LOG_FILE_NAME}</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE_ROLLING_PATTERN}</fileNamePattern>
            <maxFileSize>${LOG_FILE_ROLLING_MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${LOG_FILE_ROLLING_MAX_HISTORY}</maxHistory>
            <totalSizeCap>${LOG_FILE_ROLLING_TOTAL_SIZE_CAP}</totalSizeCap>
        </rollingPolicy>

        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <pattern>
                    <pattern>{"app":"${APP_NAME}"}</pattern>
                </pattern>
                <timestamp>
                    <fieldName>timestamp</fieldName>
                    <pattern>yyyy-MM-dd'T'HH:mm:ss.SSSZ</pattern>
                </timestamp>
                <logLevel/>
                <loggerName/>
                <message/>
                <mdc>
                    <includeMdcKeyName>traceId</includeMdcKeyName>
                    <includeMdcKeyName>spanId</includeMdcKeyName>
                </mdc>
                <stackTrace/>
            </providers>
        </encoder>
    </appender>

    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator class="ch.qos.logback.classic.boolex.JaninoEventEvaluator">
                <expression>return ${APPENDER_FILE_ENABLE};</expression>
            </evaluator>
            <OnMatch>NEUTRAL</OnMatch>
            <OnMismatch>DENY</OnMismatch>
        </filter>
        <appender-ref ref="JSON_FILE"/>
        <queueSize>8192</queueSize>
        <discardingThreshold>0</discardingThreshold>
    </appender>
</included>
